# =============================================================
# ERP Microservices - Docker Compose (전체 통합)
# =============================================================
# 실행: docker-compose up -d
# 중지: docker-compose down
# 로그: docker-compose logs -f [service-name]
# =============================================================

version: '3.8'

services:
  # =========================================
  # Infrastructure Services
  # =========================================
  
  # MySQL Database (Employee Service용)
  mysql:
    image: mysql:8.0
    container_name: erp-mysql
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: erp_employee
      MYSQL_USER: erp_user
      MYSQL_PASSWORD: erp_password
    ports:
      - "3307:3306"
    volumes:
      - mysql_data:/var/lib/mysql
      - ./scripts/init_mysql.sql:/docker-entrypoint-initdb.d/init.sql:ro
    networks:
      - erp-network
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-proot"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  # MongoDB Database (Approval Request Service용)
  mongodb:
    image: mongo:7.0
    container_name: erp-mongodb
    restart: unless-stopped
    environment:
      MONGO_INITDB_DATABASE: erp_approval
    ports:
      - "27018:27017"
    volumes:
      - mongodb_data:/data/db
    networks:
      - erp-network
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  # =========================================
  # Application Services
  # =========================================
  
  # Employee Service (Spring Boot + MySQL)
  employee-service:
    build:
      context: ./employee-service/demo
      dockerfile: Dockerfile
    container_name: employee-service
    restart: unless-stopped
    ports:
      - "8081:8081"
    environment:
      SPRING_PROFILES_ACTIVE: docker
    depends_on:
      mysql:
        condition: service_healthy
    networks:
      - erp-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8081/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # Approval Request Service (Spring Boot + MongoDB + gRPC)
  approval-request-service:
    build:
      context: .
      dockerfile: ./approval-request-service/demo/Dockerfile
    container_name: approval-request-service
    restart: unless-stopped
    ports:
      - "8082:8082"   # REST API
      - "9091:9091"   # gRPC Server
    environment:
      SPRING_PROFILES_ACTIVE: docker
    depends_on:
      mongodb:
        condition: service_healthy
      employee-service:
        condition: service_healthy
    networks:
      - erp-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8082/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # Approval Processing Service (Spring Boot + gRPC + In-Memory)
  approval-processing-service:
    build:
      context: .
      dockerfile: ./approval-processing-service/demo/Dockerfile
    container_name: approval-processing-service
    restart: unless-stopped
    ports:
      - "8083:8083"   # REST API
      - "9090:9090"   # gRPC Server
    environment:
      SPRING_PROFILES_ACTIVE: docker
    depends_on:
      approval-request-service:
        condition: service_healthy
    networks:
      - erp-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8083/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # Notification Service (TODO: 구현 필요)
  # notification-service:
  #   build:
  #     context: ./notification-service/demo
  #     dockerfile: Dockerfile
  #   container_name: notification-service
  #   restart: unless-stopped
  #   ports:
  #     - "8084:8084"
  #   environment:
  #     SPRING_PROFILES_ACTIVE: docker
  #   networks:
  #     - erp-network

# =========================================
# Volumes
# =========================================
volumes:
  mysql_data:
    driver: local
  mongodb_data:
    driver: local

# =========================================
# Networks
# =========================================
networks:
  erp-network:
    driver: bridge
